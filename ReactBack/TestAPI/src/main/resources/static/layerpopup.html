<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/css/ui.jqgrid.css" />
<link rel="stylesheet" href="https://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
 <!-- ìŠ¤í¬ë¦½íŠ¸ ì‚½ì… -->
  <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.10.4/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/js/i18n/grid.locale-en.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/js/jquery.jqGrid.min.js"></script>


<title>CFSíŒŒì¼ ì—…ë¡œë“œ</title>

  <style>
    .bitMask {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }

    .bitPopup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      z-index: 1000;
      display: none;
      width: 90%;
      max-width: 1000px;
      height: 600px;
      overflow: auto;
    }

    .btn-area {
      margin-bottom: 10px;
      text-align: right;
    }

		.popup-header {
			padding: 10px 0;
		}

		.popup-header .title {
			font-size: 20px;
			font-weight: bold;
			margin-bottom: 10px;
		}
    .popup-close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff4d4f;
      color: white;
      border: none;
      font-size: 28px;
      font-weight: bold;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      line-height: 36px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.2s ease;
    }

    .popup-close-btn:hover {
      background: #d9363e;
    }

		.popup-content {
			display: flex;
			gap: 20px;
			overflow-x: auto;
			max-height: 450px;
			align-items: flex-start;
		}

		.grid-section {
			min-width: 420px;
			flex: 1;
			box-sizing: border-box;
		}

		.section-title {
			font-size: 16px;
			font-weight: bold;
			margin-bottom: 10px;
		}

		.ui-jqgrid {
			box-sizing: border-box;
			width: 100% !important;
		}

		.ui-jqgrid .ui-jqgrid-view {
			box-sizing: border-box;
			width: 100% !important;
		}

		.ui-jqgrid-bdiv {
			max-height: 300px !important;
			overflow-y: auto !important;
		}

		.ui-jqgrid .ui-jqgrid-htable,
		.ui-jqgrid .ui-jqgrid-btable {
			border-collapse: collapse;
			border: 1px solid #ccc;
		}

		.ui-jqgrid tr.jqgrow td {
			border: 1px solid #ddd !important;
		}

		.ui-jqgrid .ui-jqgrid-htable th {
			border: 1px solid #ccc;
			background-color: #f4f4f4;
		}

  </style>
</head>

  <button onclick="openPopup()">ğŸ“‚ CFS íŒŒì¼ ê´€ë¦¬ íŒì—…</button>

  <div class="bitMask" onclick="closePopup()"></div>

	<div class="bitPopup">
	  <div class="popup-header">
		<div class="title">ğŸ“‚ CFS íŒŒì¼ ê´€ë¦¬</div><button class="popup-close-btn" onclick="closePopup()">Ã—</button>
  	  
	  </div>

	  <div class="popup-content">
		<!-- ì™¼ìª½ ê·¸ë¦¬ë“œ -->
		<div class="grid-section left">
		  <div class="section-title">íŒŒì¼ ëª©ë¡</div>
		  <div class="btn-area">
			<button onclick="addFileRow()">â• ì¶”ê°€</button>
			<button onclick="deleteSelectedRows()">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
			<button onclick="uploadFiles()">ğŸ’¾ íŒŒì¼ ì €ì¥</button>
		  </div>
        <input type="hidden" id="orderNo" name="orderNo" value="orderCd"/> 
		    <table id="fileGrid"></table>
		</div>

		<!-- ì˜¤ë¥¸ìª½ ë³´ê¸° ì „ìš© ê·¸ë¦¬ë“œ -->
		<div class="grid-section right">
		  <div class="section-title">ì—…ë¡œë“œëœ íŒŒì¼ ë¦¬ìŠ¤íŠ¸</div>
		  <table id="viewGrid"></table>
		</div>
	  </div>
	</div>

  <script>
  //ê¸°ì´ˆ ì‚¬ìš© ë°ì´í„° ì…‹íŒ…
  var strFileSharing = ":;1:ë‚´ë¶€ìš©;2:ì™¸ë¶€ìš©";
  var strUploadFileTp = ":;1:ë‚´ë¶€ìš©;2:ì™¸ë¶€ìš©";
  
    
    function fileInputFormatter(cellvalue, options, rowObject) {
        return `<input type="file" class="upfiles" data-rowid="${options.rowId}" />`;
    }

    function deleteButtonFormatter() {
        //ë‹¨ì¼ ì‚­ì œ, 
      return '<button onclick="deleteRow(this)">ì‚­ì œ</button>';
      
    }

    function saveButtonFormatter() {
      return '<button onclick="alert(\'ì €ì¥ ê¸°ëŠ¥ì€ í•„ìš”\')">ì €ì¥</button>';
    }

    function saveDownloadFormatter() {
      return '<button onclick="alert(\'ë‹¤ìš´ë¡œë“œ ë¡œì§\')">DownLoad</button>';
    }
  </script>

  <script>
    //íŒŒì¼ íŒì—… open script
    function openPopup() {
      $('.bitMask, .bitPopup').show();
      initGrid();
      initViewGrid();
      setTimeout(() => {
        $("#fileGrid").jqGrid('setGridWidth', $('.bitPopup').width() - 40);
      }, 100);

      $('.bitMask, .bitPopup').show();

      //if (!$("#fileGrid").html()) initGrid();
      //if (!$("#viewGrid").html()) initViewGrid();

      setTimeout(() => {
        $("#fileGrid, #viewGrid").each(function () {
          $(this).jqGrid('setGridWidth', $(this).closest('.grid-section').width() - 20);
        });
      }, 100);
    }


    //íŒŒì¼íŒì—… ë‹«ê¸°ê¸°
    function closePopup() {
      $('.bitMask, .bitPopup').hide();
      $("#fileGrid").jqGrid('clearGridData');
    }


    function initGrid() {
      $("#fileGrid").jqGrid({
        datatype: "local",
        colNames: ['íŒŒì¼ì—…ë¡œë“œíƒ€ì…', 'ê³µê°œì—¬ë¶€', 'íŒŒì¼'],
        colModel: [
          { name: 'uploadFileTp', editable :true, edittype:'select', editoptions: { value: strUploadFileTp }, formatter: 'select', width: 150 },
          { name: 'filePublicTp', editable :true, edittype:'select', editoptions: { value: "1:ê³µê°œ;2:ë¹„ê³µê°œ" }, formatter: 'select', width: 50 },
          { name: 'files', formatter: fileInputFormatter, sortable: false }
        ],
        cellEdit: true,
        editurl: 'clientArray',  // <- inline editì„ ìœ„í•´ í•„ìš”
        cellsubmit: 'clientArray',
        multiselect: true,
        height: 'auto',
        autowidth: true,
        rownumbers: true,
        
        onCellSelect: function (rowid, iCol, cellcontent, e) {
          const cm = $("#fileGrid").jqGrid("getGridParam", "colModel");
          const colName = cm[iCol].name;
          if (cm[iCol].editable) {
            $("#fileGrid").jqGrid("editCell", rowid, iCol, true);
          }
        } 
      });
      addFileRow(); // ì²« í–‰
    }

    function addFileRow() {
      const newId = $("#fileGrid").jqGrid('getDataIDs').length + 1;
      $("#fileGrid").jqGrid('addRowData', newId, {
        uploadFileTp: "1", // ê¸°ë³¸ê°’
        filePublicTp: "1",
        file: ""
      });
    }

    function deleteSelectedRows() {
      const selectedIds = $("#fileGrid").jqGrid("getGridParam", "selarrrow");
      selectedIds.slice().reverse().forEach(id => {
          $("#fileGrid").jqGrid("delRowData", id);
        });
    }


    

      function uploadFiles() {
        const formData = new FormData();
        formData.append("orderNo", $("#orderNo").val());
        let allRowIds = $("#fileGrid").jqGrid("getDataIDs");
        let rowDataList = [];
        for (let i = 0; i < allRowIds.length; i++) {
          let rowId = allRowIds[i];

          // íŒŒì¼ input ì°¾ì•„ì˜¤ê¸°
          let fileInput = document.querySelector(`.upfiles[data-rowid="${rowId}"]`);

          // íŒŒì¼ì´ ì—†ìœ¼ë©´ ì´ í–‰ì€ ê±´ë„ˆë›°ê¸°
          if (!fileInput || fileInput.files.length === 0) {
              continue;
          }

          // íŒŒì¼ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ë°ì´í„° ì¶”ì¶œí•´ì„œ ì¶”ê°€
          let rowData = $("#fileGrid").jqGrid("getRowData", rowId);
          rowDataList.push({
              uploadFileTp: rowData.uploadFileTp,
              filePublicTp: rowData.filePublicTp,
              rowId: rowId
          });

          formData.append("upfiles", fileInput.files[0]);  // íŒŒì¼ ì¶”ê°€
          debugger;
        }

        // JSONìœ¼ë¡œ ë°ì´í„° ì „ì†¡
        formData.append("gridData", JSON.stringify(rowDataList));

        // ì—…ë¡œë“œí•  í–‰ì´ í•˜ë‚˜ë„ ì—†ë‹¤ë©´ ì¤‘ë‹¨
        if (rowDataList.length === 0) {
            alert("ì €ì¥í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        // JSONìœ¼ë¡œ ë°ì´í„° ì „ì†¡
        formData.append("gridData", JSON.stringify(rowDataList));

      // FormDataì˜ ë‚´ìš©ì„ ì½˜ì†”ì— ì¶œë ¥í•˜ê¸°
        for (let pair of formData.entries()) {
            console.log(pair[0] + ": " + pair[1]);
        }
        
        $.ajax({
            url: '/api/upload/param.do', // ì—¬ê¸°ì— ì‹¤ì œ ì—…ë¡œë“œ URL
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (res) {
                console.log("ì—…ë¡œë“œ ì„±ê³µ", res);
                alert("ì—…ë¡œë“œ ì™„ë£Œ!");
            },
            error: function (err) {
                console.error("ì—…ë¡œë“œ ì‹¤íŒ¨", err);
                alert("ì—…ë¡œë“œ ì‹¤íŒ¨!");
            }
        });
    }


</script>
<script>

    function deleteRow(btn) {
      const rowId = $(btn).closest('tr.jqgrow').attr('id');
      $("#fileGrid").jqGrid('delRowData', rowId);
    }

        function initViewGrid() {
          $("#viewGrid").jqGrid({
            datatype: "local",
            colNames: ['íŒŒì¼ì—…ë¡œë“œíƒ€ì…', 'ê³µê°œì—¬ë¶€', 'íŒŒì¼ëª…', 'ì‚­ì œ', 'ì €ì¥', 'ë‹¤ìš´ë¡œë“œ', 'íŒŒì¼seq'],
            colModel: [
              { name: 'uploadFileTp', editable :false, edittype:'select', editoptions: { value: strUploadFileTp }, formatter: 'select' },
              { name: 'filePublicTp', editable :false, edittype:'select', editoptions: { value: "1:ê³µê°œ;2:ë¹„ê³µê°œ" }, formatter: 'select' },
              { name: 'fileNm', width: 200 },
              { name: 'delete', formatter: deleteButtonFormatter, width: 80, sortable: false },
              { name: 'save', formatter: saveButtonFormatter, width: 100, sortable: false },
              { name: 'download', formatter: saveDownloadFormatter, width: 100, sortable: false },
              { name: 'seqNo', hidden: true },

            ],
            height: 'auto',
            autowidth: true
            
          });
          // ì˜ˆì‹œ ë°ì´í„°
          $("#viewGrid").jqGrid('addRowData', 1, { uploadFileTp: "1", filePublicTp: "1" });
          $("#viewGrid").jqGrid('addRowData', 2, { uploadFileTp: "2", filePublicTp: "2"  });
        }

  </script>
</body>
</html>
